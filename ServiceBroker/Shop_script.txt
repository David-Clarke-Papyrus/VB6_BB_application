--================================================
--    O n  C l  i e n t
--================================================
USE [MASTER]
GO
DROP CERTIFICATE WWLB_FEEDDATASOURCE_CERTIFICATE
CREATE MASTER KEY ENCRYPTION BY PASSWORD = '9Crank0'
CREATE CERTIFICATE [WWLB_FEEDDATASOURCE_CERTIFICATE] WITH SUBJECT  = 'WWLB_FEEDDATASOURCE_CERTIFICATE', START_DATE = '10/31/2009', EXPIRY_DATE = '10/31/2100'
BACKUP CERTIFICATE [WWLB_FEEDDATASOURCE_CERTIFICATE] TO FILE = 'C:\PBKS\BU\WWLB_FEEDDATASOURCE_CERTIFICATE.cer'

GO

CREATE ENDPOINT [WWLB_FEEDDATASOURCE_ENDPOINT] STATE=STARTED
AS TCP (LISTENER_PORT = 4022)
FOR SERVICE_BROKER ( AUTHENTICATION = CERTIFICATE WWLB_FEEDDATASOURCE_CERTIFICATE )



================================================On Central or HUB=====================================
CREATE LOGIN [WWLB_DATASOURCE] WITH PASSWORD=N'9Crank0';
CREATE USER [WWLB_DATASOURCE];
CREATE CERTIFICATE WWLB_DATASOURCE_CERTIFICATE AUTHORIZATION WWLB_DATASOURCE
FROM FILE ='C:\PBKS\BU\WWLB_FEEDDATASOURCE_CERTIFICATE.cer';
GRANT CONNECT ON ENDPOINT::HUB_ENDPOINT TO [WWLB_DATASOURCE]
USE PBKSC or HUB
GRANT SEND ON SERVICE::LOYALTYFEED_DATACONSUMER_SERVICE to [PUBLIC]
===========O R ===================================(on Shop DB) =======================================
CREATE LOGIN [CENTRAL_DATASOURCE] WITH PASSWORD=N'9Crank0';
CREATE USER [CENTRAL_DATASOURCE];
CREATE CERTIFICATE [CENTRAL_DATACONSUMBER_CERTIFICATE] AUTHORIZATION [CENTRAL_DATASOURCE]
FROM FILE = 'C:\PBKS\BU\CENTRAL_FEEDDATACONSUMER_CERTIFICATE.cer';
GRANT CONNECT ON ENDPOINT::WWLB_FEEDDATASOURCE_ENDPOINT TO [CENTRAL_DATASOURCE];
USE PBKS
GRANT SEND ON SERVICE::C_LOYALTYFEED_DATASOURCE_SERVICE to [PUBLIC]


USE [PBKS]
GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[SessionConversations](
	[SPID] [int] NOT NULL,
	[FromService] [sysname] COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
	[ToService] [sysname] COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
	[OnContract] [sysname] COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,
	[Handle] [uniqueidentifier] NOT NULL,
PRIMARY KEY CLUSTERED 
(
	[SPID] ASC,
	[FromService] ASC,
	[ToService] ASC,
	[OnContract] ASC
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY],
UNIQUE NONCLUSTERED 
(
	[Handle] ASC
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

CREATE MESSAGE TYPE [BUKFEED_TRIGGER] AUTHORIZATION [dbo] VALIDATION = NONE
GO

CREATE MESSAGE TYPE [BULKFEED] AUTHORIZATION [dbo] VALIDATION = NONE
GO

CREATE MESSAGE TYPE [DELFEED] AUTHORIZATION [dbo] VALIDATION = NONE
GO

CREATE CONTRACT [FEED_CONTRACT] AUTHORIZATION [dbo] ([BUKFEED_TRIGGER] SENT BY INITIATOR,
[BULKFEED] SENT BY TARGET,
[DELFEED] SENT BY INITIATOR)
GO

CREATE QUEUE [dbo].[FEED_DATASOURCE_Q] WITH STATUS = ON , RETENTION = OFF , ACTIVATION (  STATUS = ON , PROCEDURE_NAME = [dbo].[actp_ProductReply] , MAX_QUEUE_READERS = 1 , EXECUTE AS N'dbo'  ) ON [PRIMARY] 
GO

CREATE SERVICE [FEED_DATASOURCE_SERVICE]  AUTHORIZATION [dbo]  ON QUEUE [dbo].[FEED_DATASOURCE_Q] ([FEED_CONTRACT])
GO

CREATE ROUTE [FEED_ROUTE_TO_DATACONSUMER]   AUTHORIZATION [dbo]   WITH  SERVICE_NAME  = N'FEED_DATACONSUMER_SERVICE' ,  ADDRESS  = N'TCP://5.176.51.45:4022' 
GO





--===============================================
--    O n    T a r g e t    C E N T R A L
--===============================================

USE [MASTER]
GO

create master key encryption by password = '33MontBleu';

CREATE CERTIFICATE [CENTRAL_FEEDDATACONSUMER_CERTIFICATE] WITH SUBJECT  = 'CENTRAL_FEEDDATACONSUMER_CERTIFICATE'
BACKUP CERTIFICATE [CENTRAL_FEEDDATACONSUMER_CERTIFICATE] TO FILE 'C:\PBKS\BU\CENTRAL_FEEDDATACONSUMER_CERTIFICATE.cer'
GO

CREATE ENDPOINT [CENTRAL_FEEDDATACONSUMER_ENDPOINT] STATE=STARTED
AS TCP (LISTENER_PORT = 4022)
FOR SERVICE_BROKER ( AUTHENTICATION = CERTIFICATE [CENTRAL_FEEDDATACONSUMER_CERTIFICATE] )


--===============================================
--    O n    T a r g e t    C L I E N T
--===============================================

USE [MASTER]
GO

create master key encryption by password = '33MontBleu';
--Use same certificate and endpoint as for the feed to HUB
--WIll have to add the public key of CENTRAL to the client as well